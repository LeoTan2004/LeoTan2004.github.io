# JVM学习

## Java面相对象的底层表现形式

**HotSpot**采用***oop-Klass***模型表示Java的面相对象和类。oop(ordinary object pointer)指普通的对象指针，Klass表示对象的具体类型。

### Klass

Klass类继承MetaDat12a，Klass类的结构如下

| 字段名                     | 类型                                          | 说明                                                         |
| -------------------------- | --------------------------------------------- | ------------------------------------------------------------ |
| _layout_helper             | **jint**(*int*)                               | 对象布局的总和描述符，如果不是对象或者数组（比如常量池），这个值为0，否则这个值将代表4个组合数，组合数具体有什么含义有子类实现 |
| _name                      | Symbol* (char*)                               | 类名                                                         |
| _primary_supers            | Klass*[]（Klass指针数组）                     | 表示当前类的父类的继承链，默认长度为8，可以通过`-XX:FastSuperclassLimit=5`将限制改为5。当超出限度时，超出的部分会放入**_secondary_supers**中。<br/>例如当前类A继承B，B继承C，那么数组中存放的就是{A,B,C} |
| _java_mirror               | oop（oopDesc*类型）                           | 保存当前Klass实例在Java类所对应的java.lang.Class的对象，可以据此访问**静态属性** |
| _super_check_offset        | juint(unsigned int)                           | 指向继承链中自己的位置与自己实例的其实地址的偏移量。比如上面的例子中，这个值就是（2+primary_supers偏移量） ， 因为 **primary_supers**[2]中的指正指向的就是A的Klass。<br>当继承链大于8时，他的值就和_**secondary_super_cache**一样 |
| _secondary_supers          | Array<Klass*>  * <br>(可动态变化的*数组指针*) | 一般存储Java类实现的接口，偶尔还会存储Java类以及其父类       |
| _secondary_supers_cache    | Klass*                                        | 保存上一次查询父类的结果                                     |
| _super                     | Klass*                                        | 指向Java类的直接父类                                         |
| _subklass                  | Klass*                                        | 指向Java类的直接子类，多个子类会通过_next_sibling连接起来    |
| _next_sibling              | Klass*                                        | 获取当前类的兄弟子类（二者直接继承同一个父类）               |
| _next_link                 | Klass*                                        | 指向ClassLoader加载的下一个Klass                             |
| _class_loader_data         | ClassLoaderData*                              | 通过此属性找到加载该Java类的ClassLoader                      |
| _access_flags              | AccessFlags                                   | 权限修饰符，比如private、final、static、abstract、native等   |
| _prototype_header          | markOop                                       | 和锁的实现有关                                               |
| _modified_oops             | jbyte(byte)                                   | 和GC实现有关，可用于YC、CMS                                  |
| _accumulated_modified_oops | jbyte(byte)                                   | 和GC有关，仅用于CMS                                          |

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="857" height="357" viewBox="-0.5 -0.5 857 357" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2023-10-23T09:36:33.098Z&quot; agent=&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/20.6.2 Chrome/106.0.5249.199 Electron/21.3.3 Safari/537.36&quot; version=&quot;20.6.2&quot; etag=&quot;BXwI4JaKkmoUrpkhQ7GJ&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;XKCQ9xHuUm15ooh5mlrK&quot; name=&quot;第 1 页&quot;&gt;7Zpbc6IwFIB/jY+bIYRweaxot51tp53tzuzuY5RUaJE4MVbZX7+giSRSWtuOg5aaB83JlXP5OER6KJyuvnMyi69ZRNOebUWrHhr0bBvanl98lZJ8I3FhsBFMeBLJTpXgLvlHpdCS0kUS0bnRUTCWimRmCscsy+hYGDLCOVua3e5Zaq46IxNaE9yNSVqX/k4iEUspdIOq4YImk1gu7dvepmFExo8TzhaZXK9nI9tHLpT6mBI1l7zQeUwittQWRcMeCjljYvNrugppWupWqW0z7ryhdbtvTjOxz4A4zx8uLycWv+/T0L24+bni0bdyQDnNE0kXVF3HerciVxoqL3Imu1Eu6Oo5u5CR6m7VN1ZdbuFGlE2p4HnRRU2E5BDpQdCT9WVlDx9LWayZAikhkT4w2c5d6aH4IVXxBrXAmlauqSAREaSmnbUH0HIy2EP9ZZwIejcj47J1WURMIYvFNJXN90mahixlfD0W9UM3tHEhnwvOHqnWMhicQTwsR7BMaPLz4fnZ0CrkjfbQ9f6CyRutgbEFsOtDVYKaLSDEILC0YtdN4yLgIr0cyFDodfelURHvssq4iNmEZSQdVtK+acKqzxVjMyl8oELkEl5kIZhp1rebLyUjmva3BNG6SIYoC5e7f499CxWwBR/TlzpK2hI+oS9N2BC9nKZEJE/m7p4z8HroGeck1zrMWJKJuTbzbSmo3NBBDnCx5mTIYASCoHLRsng7rrRZr3Ks7cbf72t1VP5IyXz+6YmAPBd4loO3xTFMEWCgtRXlqIHhtsGHQv08/1NULFX5W1YAVtXBSm8c5LJ2mlxx9uRKg9cdlivFB0CdK2bqYXvA9vRyeKw4NaxcZnNBsjHtBl4gdoDBD3cnGzxuoHitAgV2ASj4mIHiYtdMRVoHCq4BZb1IN2iCAx/49bBX5ggsExxHjZbg6+Hm3czw92SG80FmfMjAfuOt/zrhnPFuhOwrCYDtu+CZaDvSmIWtxGi38gF1dHzw4H5XQoB2/NV8WrYtM12Qx+cHTQiUvp7hTFgS5oqRqBuoQVYAdFDAt5KmAVWtkMZplTSdOMqA6JhJgz0Q6N64c99sgzT183hFmp/0/pMz5jTzleArXzk4Rdw9KYLbfBhRu9Ri91c+ox06O/AsDCBsOjs4sbj2v7KDg8e1dxJx7dXi+mb00KGwxpZtnsHiE45rpZSv+/UBX4zY93yhlTcjvMAGVv3/9jZfjKifL4RsnfaLW8bSTw8YDzkvnCpACE2+tPV/ZlGt3jbc2L56pRMN/wM=&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(40, 54, 24);"><defs><filter id="dropShadow"><feGaussianBlur in="SourceAlpha" stdDeviation="1.7" result="blur"/><feOffset in="blur" dx="3" dy="3" result="offsetBlur"/><feFlood flood-color="#3D4574" flood-opacity="0.4" result="offsetColor"/><feComposite in="offsetColor" in2="offsetBlur" operator="in" result="offsetBlur"/><feBlend in="SourceGraphic" in2="offsetBlur"/></filter></defs><g filter="url(#dropShadow)"><rect x="550.57" y="0" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 32px; margin-left: 552px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">Metadata</div></div></div></foreignObject><text x="609" y="35" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">Metadata</text></switch></g><path d="M 434.7 95.45 L 434.7 41.8 Q 434.7 31.8 444.7 31.8 L 544.2 31.8" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 549.45 31.8 L 542.45 35.3 L 544.2 31.8 L 542.45 28.3 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="376.7" y="95.45" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 127px; margin-left: 378px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">Klass</div></div></div></foreignObject><text x="435" y="131" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">Klass</text></switch></g><path d="M 222.2 175 L 222.2 137.3 Q 222.2 127.3 232.2 127.3 L 370.34 127.27" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 375.59 127.27 L 368.59 130.77 L 370.34 127.27 L 368.59 123.77 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="154.55" y="175" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 207px; margin-left: 156px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">InstanceKlass</div></div></div></foreignObject><text x="213" y="210" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">InstanceKlass</text></switch></g><path d="M 656.9 190.91 L 656.9 137.3 Q 656.9 127.3 646.9 127.3 L 498.98 127.27" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 493.73 127.27 L 500.73 123.77 L 498.98 127.27 L 500.73 130.77 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="598.86" y="190.91" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 223px; margin-left: 600px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">ArrayKlass</div></div></div></foreignObject><text x="657" y="226" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">ArrayKlass</text></switch></g><path d="M 212.5 286.36 L 212.5 245" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 212.5 239.75 L 216 246.75 L 212.5 245 L 209 246.75 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="154.55" y="286.36" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 318px; margin-left: 156px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">InstanceMirrorKlass</div></div></div></foreignObject><text x="213" y="322" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">InstanceMirrorKlass</text></switch></g><path d="M 386.4 286.36 L 386.4 216.8 Q 386.4 206.8 376.4 206.8 L 276.82 206.82" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 271.57 206.82 L 278.57 203.32 L 276.82 206.82 L 278.57 210.32 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="309.09" y="286.36" width="154.55" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 153px; height: 1px; padding-top: 318px; margin-left: 310px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">InstanceClassLoadKlass</div></div></div></foreignObject><text x="386" y="322" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">InstanceClassLoadKlass</text></switch></g><path d="M 58 286.36 L 58 216.8 Q 58 206.8 68 206.8 L 148.18 206.82" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 153.43 206.82 L 146.43 210.32 L 148.18 206.82 L 146.43 203.32 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="286.36" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 318px; margin-left: 1px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">InstanceRefKlass</div></div></div></foreignObject><text x="58" y="322" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">InstanceRefKlass</text></switch></g><path d="M 763 286.36 L 763 232.7 Q 763 222.7 753 222.71 L 721.14 222.72" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 715.89 222.73 L 722.89 219.22 L 721.14 222.72 L 722.89 226.22 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="705.11" y="286.36" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 318px; margin-left: 706px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">TypeArrayKlass</div></div></div></foreignObject><text x="763" y="322" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">TypeArrayKlass</text></switch></g><path d="M 560.3 286.36 L 560.3 232.7 Q 560.3 222.7 570.3 222.71 L 592.5 222.72" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 597.75 222.73 L 590.74 226.22 L 592.5 222.72 L 590.75 219.22 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="502.27" y="286.36" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 318px; margin-left: 503px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">ObjArrayKlass</div></div></div></foreignObject><text x="560" y="322" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">ObjArrayKlass</text></switch></g><path d="M 792 111.36 L 792 41.8 Q 792 31.8 782 31.8 L 672.85 31.82" fill="none" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><path d="M 667.6 31.82 L 674.59 28.32 L 672.85 31.82 L 674.6 35.32 Z" fill="#dda15e" stroke="#dda15e" stroke-miterlimit="10" pointer-events="none"/><rect x="734.09" y="111.36" width="115.91" height="63.64" rx="9.55" ry="9.55" fill="#bc6c25" stroke="#dda15e" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 114px; height: 1px; padding-top: 143px; margin-left: 735px;"><div data-drawio-colors="color: #FEFAE0; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(254, 250, 224); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;">ConstantPool</div></div></div></foreignObject><text x="792" y="147" fill="#FEFAE0" font-family="Helvetica" font-size="12px" text-anchor="middle">ConstantPool</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>

